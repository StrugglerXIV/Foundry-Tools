{"version":3,"file":"main.js","sources":["../../src/effects/autoEffects.js","../../src/main.js"],"sourcesContent":["export async function applyEffectsToSelectedTokens() {\r\n    if (!canvas.tokens.controlled.length) {\r\n        ui.notifications.warn(\"Please select at least one token.\");\r\n        return;\r\n    }\r\n\r\n    for (const token of canvas.tokens.controlled) {\r\n        const actor = token.actor;\r\n        const sourceActor = actor.isToken ? game.actors.get(actor.id) : actor;\r\n        const newEffects = [];\r\n\r\n        const cr = actor.system.details.cr ?? 0;\r\n        const halfCR = Math.ceil(cr / 2);\r\n\r\n        // 🔁 Check effects on the correct actor\r\n        const hasEffect = label => sourceActor.effects.some(e => e.label === label);\r\n\r\n        // 1. Proficiency Boost\r\n        if (cr > 0 && !hasEffect(\"Proficiency Boost\")) {\r\n            newEffects.push({\r\n                label: \"Proficiency Boost\",\r\n                icon: \"icons/svg/up.svg\",\r\n                changes: [\r\n                    {\r\n                        key: \"system.attributes.prof\",\r\n                        mode: CONST.ACTIVE_EFFECT_MODES.ADD,\r\n                        value: halfCR,\r\n                        priority: 20\r\n                    }\r\n                ],\r\n                origin: `Actor.${sourceActor.id}`,\r\n                disabled: false,\r\n                duration: { rounds: 0 },\r\n                flags: { \"foundry-tools\": { owned: true } }\r\n            });\r\n        }\r\n\r\n        // 2. Default + Existing Resistances to -@prof\r\n        let existingDrRaw = actor.system.traits.dr?.value ?? [];\r\n        if (typeof existingDrRaw !== \"object\") existingDrRaw = [];\r\n        const drList = Array.isArray(existingDrRaw)\r\n            ? existingDrRaw\r\n            : Object.values(existingDrRaw).filter(v => typeof v === \"string\");\r\n        const dr = new Set(drList);\r\n\r\n        // Add defaults\r\n        [\"bludgeoning\", \"slashing\", \"piercing\"].forEach(r => dr.add(r));\r\n\r\n        console.log(\"Final DR set:\", [...dr]);\r\n\r\n\r\n        if (!hasEffect(\"Custom Resistances\") && dr.size > 0) {\r\n            const resChanges = Array.from(dr).map(type => ({\r\n                key: `system.traits.dm.amount.${type}`,\r\n                mode: CONST.ACTIVE_EFFECT_MODES.ADD,\r\n                value: \"-@prof\",\r\n                priority: 20\r\n            }));\r\n\r\n            newEffects.push({\r\n                label: \"Custom Resistances\",\r\n                icon: \"icons/svg/shield.svg\",\r\n                changes: resChanges,\r\n                origin: `Actor.${sourceActor.id}`,\r\n                disabled: false,\r\n                duration: { rounds: 0 },\r\n                flags: { \"foundry-tools\": { owned: true } }\r\n            });\r\n        }\r\n\r\n        // 3. Immunities to -(@prof*2)\r\n        const di = new Set(actor.system.traits.di.value || []);\r\n        if (!hasEffect(\"Custom Immunities\") && di.size > 0) {\r\n            const imuChanges = Array.from(di).map(type => ({\r\n                key: `system.traits.dm.amount.${type}`,\r\n                mode: CONST.ACTIVE_EFFECT_MODES.ADD,\r\n                value: \"-(@prof*2)\",\r\n                priority: 20\r\n            }));\r\n\r\n            newEffects.push({\r\n                label: \"Custom Immunities\",\r\n                icon: \"icons/svg/shield.svg\",\r\n                changes: imuChanges,\r\n                origin: `Actor.${sourceActor.id}`,\r\n                disabled: false,\r\n                duration: { rounds: 0 },\r\n                flags: { \"foundry-tools\": { owned: true } }\r\n            });\r\n        }\r\n\r\n        // 4. Clear native traits\r\n        await actor.update({\r\n            \"system.traits.dr.value\": [],\r\n            \"system.traits.di.value\": []\r\n        });\r\n\r\n        // 5. Jack of All Trades\r\n        if (!hasEffect(\"Jack of All Trades\")) {\r\n            newEffects.push({\r\n                label: \"Jack of All Trades\",\r\n                icon: \"icons/svg/dice-target.svg\",\r\n                changes: [\r\n                    {\r\n                        key: \"flags.dnd5e.jackOfAllTrades\",\r\n                        mode: CONST.ACTIVE_EFFECT_MODES.OVERRIDE,\r\n                        value: true,\r\n                        priority: 20\r\n                    }\r\n                ],\r\n                origin: `Actor.${sourceActor.id}`,\r\n                disabled: false,\r\n                duration: { rounds: 0 },\r\n                flags: { \"foundry-tools\": { owned: true } }\r\n            });\r\n        }\r\n\r\n        // 6. Size-Based Damage Bonus\r\n        if (!hasEffect(\"Size-Based Damage Bonus\")) {\r\n            const sizeMap = {\r\n                tiny: 0.5,\r\n                sm: 1,\r\n                med: 1,\r\n                lg: 2,\r\n                huge: 3,\r\n                grg: 4\r\n            };\r\n            const sizeMult = sizeMap[actor.system.traits.size] || 1;\r\n            const numDice = Math.max(1, Math.floor(sizeMult));\r\n            const formula = actor.system.attributes.hp.formula || \"1d8\";\r\n            const die = formula.match(/d\\d+/)?.[0] || \"d8\";\r\n\r\n            newEffects.push({\r\n                label: \"Size-Based Damage Bonus\",\r\n                icon: \"icons/svg/dice-target.svg\",\r\n                changes: [\r\n                    {\r\n                        key: \"system.bonuses.All-Damage\",\r\n                        mode: CONST.ACTIVE_EFFECT_MODES.ADD,\r\n                        value: `${numDice}${die}`,\r\n                        priority: 20\r\n                    }\r\n                ],\r\n                origin: `Actor.${sourceActor.id}`,\r\n                disabled: false,\r\n                duration: { rounds: 0 },\r\n                flags: { \"foundry-tools\": { owned: true } }\r\n            });\r\n        }\r\n\r\n        // 7. Apply effects to source actor\r\n        if (newEffects.length > 0) {\r\n            await sourceActor.createEmbeddedDocuments(\"ActiveEffect\", newEffects);\r\n        }\r\n\r\n        ui.notifications.info(`${sourceActor.name}: Effects applied successfully.`);\r\n    }\r\n\r\n}","import { applyEffectsToSelectedTokens } from './effects/autoEffects.js';\n\nHooks.once(\"ready\", () => {\n  console.log(\"Creature Auto Effects | Ready\");\n\n  game.creatureAutoEffects = {\n    applyEffectsToSelectedTokens\n  };\n\n  // Add control button here too\n  Hooks.on(\"getSceneControlButtons\", (controls) => {\n    const tokenControls = controls.find(c => c.name === \"token\");\n    if (!tokenControls || !game.user.isGM) return;\n\n    tokenControls.tools.push({\n      name: \"apply-creature-effects\",\n      title: \"Apply Creature Effects\",\n      icon: \"fas fa-magic\",\n      visible: true,\n      onClick: () => game.creatureAutoEffects.applyEffectsToSelectedTokens(),\n      button: true\n    });\n  });\n});\n"],"names":[],"mappings":"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"}